<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - Controle Total</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>body { background-color: #f3f4f6; font-family: sans-serif; }</style>
</head>
<body class="p-6 hidden" id="corpo-pagina"> 

    <div class="max-w-7xl mx-auto space-y-8">
        <div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm">
            <h1 class="text-2xl font-bold text-gray-800">Painel Administrativo</h1>
            <div class="text-sm text-gray-500 flex items-center gap-4">
                <span>Logado: <span id="admin-email" class="font-bold text-gray-800">...</span></span>
                <button onclick="window.location.reload()" class="text-blue-600 hover:underline">üîÑ Atualizar Tela</button>
                <button onclick="sair()" class="text-red-500 hover:underline border border-red-200 px-3 py-1 rounded">Sair</button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            
            <div class="bg-white p-4 rounded-xl shadow md:col-span-1 h-[500px] overflow-y-auto">
                <h2 class="text-green-600 font-bold mb-4 flex items-center gap-2">
                    1. Selecionar Cliente
                </h2>
                <input type="text" id="busca-cliente" placeholder="Buscar nome..." class="w-full p-2 border rounded mb-2 text-sm" onkeyup="filtrarClientes()">
                <div id="lista-clientes" class="space-y-2">
                    <p class="text-gray-400 text-sm">Carregando...</p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow md:col-span-2">
                <h2 class="text-green-600 font-bold mb-6">2. Lan√ßar Nova Cobran√ßa</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Cliente</label>
                        <input type="text" id="cliente-selecionado" class="w-full p-3 bg-gray-100 border rounded text-gray-500" disabled placeholder="Selecione na lista ‚Üê">
                        <input type="hidden" id="id-cliente-selecionado">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Valor (R$)</label>
                        <input type="text" id="valor-produto" class="w-full p-3 border rounded bg-gray-50">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Produto</label>
                    <select id="select-produto" class="w-full p-3 border rounded focus:ring-2 focus:ring-green-500" onchange="atualizarPreco()">
                        <option value="">Selecione um produto...</option>
                    </select>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Chave PIX (Copia e Cola)</label>
                    <textarea id="pix-code" rows="3" class="w-full p-3 border rounded focus:ring-2 focus:ring-green-500 font-mono text-xs" placeholder="Cole o c√≥digo PIX grand√£o aqui..."></textarea>
                </div>

                <button onclick="lancarPedido()" id="btn-lancar" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg transition-colors">
                    + Lan√ßar Cobran√ßa
                </button>
                <p id="msg-status" class="mt-3 text-center text-sm font-medium"></p>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow overflow-hidden">
            <div class="p-6 border-b border-gray-100">
                <h2 class="text-blue-600 font-bold text-lg">Gerenciar Vendas Pendentes</h2>
                <p class="text-sm text-gray-500">Aqui voc√™ pode atualizar o c√≥digo Pix de quem ainda n√£o pagou.</p>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="p-4 text-sm text-gray-600">ID</th>
                            <th class="p-4 text-sm text-gray-600">Cliente (ID/Email)</th>
                            <th class="p-4 text-sm text-gray-600">Produto</th>
                            <th class="p-4 text-sm text-gray-600">Valor</th>
                            <th class="p-4 text-sm text-gray-600">Pix Atual</th>
                            <th class="p-4 text-sm text-gray-600">A√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody id="tabela-vendas" class="divide-y divide-gray-100">
                        <tr><td colspan="6" class="p-4 text-center text-gray-400">Carregando vendas...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        // SUAS CHAVES REAIS AQUI
        const supabaseUrl = 'https://eedegpggzooimuvytmyt.supabase.co'
        const supabaseKey = 'sb_publishable_7ib6PE-capYPhqdTrS0m2w_3d9QWE8x' // Essa chave √© p√∫blica, ok usar no front
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey)

        // --- 1. SEGURAN√áA ---
        async function verificarAdmin() {
            const { data: { user } } = await _supabase.auth.getUser();

            if (!user) {
                window.location.href = "/minha-conta"; 
                return;
            }

            // Verifica na tabela 'admins'
            const { data: adminList } = await _supabase
                .from('admins')
                .select('*')
                .eq('email', user.email);

            if (!adminList || adminList.length === 0) {
                alert("ACESSO NEGADO.");
                window.location.href = "/dashboard"; 
            } else {
                document.getElementById('corpo-pagina').classList.remove('hidden');
                document.getElementById('admin-email').innerText = user.email;
                iniciarPainel();
            }
        }
        verificarAdmin();

        async function iniciarPainel() {
            carregarClientes();
            carregarProdutos();
            carregarVendasPendentes(); // Nova fun√ß√£o
        }

        // --- 2. FUN√á√ïES DE CRIA√á√ÉO (SEU C√ìDIGO ORIGINAL) ---
        async function carregarClientes() {
            const { data } = await _supabase.from('clientes').select('*').order('nome', { ascending: true });
            const lista = document.getElementById('lista-clientes');
            lista.innerHTML = "";

            if (data) {
                data.forEach(cliente => {
                    const nomeCompleto = `${cliente.nome} ${cliente.sobrenome}`;
                    const item = document.createElement('div');
                    item.className = "p-3 border rounded cursor-pointer hover:bg-green-50 transition-colors flex justify-between items-center cliente-item";
                    item.innerHTML = `<span class="font-medium capitalize text-sm">${nomeCompleto}</span> <span class="text-xs text-gray-400">Selecionar</span>`;
                    
                    item.onclick = () => {
                        document.querySelectorAll('.cliente-item').forEach(d => d.classList.remove('bg-green-100', 'border-green-500'));
                        item.classList.add('bg-green-100', 'border-green-500');
                        document.getElementById('cliente-selecionado').value = nomeCompleto; 
                        document.getElementById('id-cliente-selecionado
