<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Painel de Vendas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>body { background-color: #f3f4f6; font-family: sans-serif; }</style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div id="tela-login" class="flex flex-col items-center justify-center h-screen px-4">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Acesso Restrito üîí</h2>
            <form onsubmit="event.preventDefault(); fazerLogin();">
                <label class="block text-sm font-medium text-gray-700 mb-1">E-mail Admin</label>
                <input type="email" id="login-email" class="w-full p-3 border rounded mb-4" placeholder="admin@exemplo.com" required>
                
                <label class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                <input type="password" id="login-senha" class="w-full p-3 border rounded mb-6" placeholder="******" required>
                
                <button type="submit" id="btn-login" class="w-full bg-blue-600 text-white p-3 rounded font-bold hover:bg-blue-700 transition">
                    ENTRAR NO PAINEL
                </button>
            </form>
            <p id="msg-login" class="text-center mt-4 text-sm text-red-500"></p>
        </div>
    </div>

    <div id="painel-principal" class="hidden p-6 max-w-7xl mx-auto space-y-8">
        
        <div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm">
            <h1 class="text-2xl font-bold text-gray-800">Gerenciar Vendas</h1>
            <div class="text-sm text-gray-500 flex items-center gap-4">
                <span class="hidden md:inline">Logado: <strong id="user-email">...</strong></span>
                <button onclick="sair()" class="text-red-500 hover:bg-red-50 px-3 py-1 rounded border border-red-200">Sair</button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-white p-4 rounded-xl shadow md:col-span-1 h-[500px] overflow-y-auto">
                <h2 class="text-green-600 font-bold mb-4 sticky top-0 bg-white pb-2 border-b">1. Selecionar Cliente</h2>
                <input type="text" id="busca-cliente" placeholder="Filtrar nome..." class="w-full p-2 border rounded mb-2 text-sm" onkeyup="filtrarClientes()">
                <div id="lista-clientes" class="space-y-2 text-sm">
                    <p class="text-gray-400">Carregando...</p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow md:col-span-2">
                <h2 class="text-green-600 font-bold mb-6">2. Dados da Cobran√ßa</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">Cliente Selecionado</label>
                        <input type="text" id="cliente-nome" class="w-full p-3 bg-gray-100 border rounded text-gray-600 font-medium" disabled placeholder="Selecione na lista ‚Üê">
                        <input type="hidden" id="cliente-id">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">Valor (R$)</label>
                        <input type="text" id="campo-valor" class="w-full p-3 border rounded font-bold text-gray-800" placeholder="Ex: 150.00">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="text-xs font-bold text-gray-500 uppercase">Produto</label>
                    <select id="select-produto" class="w-full p-3 border rounded bg-white" onchange="aoMudarProduto()">
                        <option value="">Selecione...</option>
                    </select>
                </div>

                <div class="mb-6">
                    <label class="text-xs font-bold text-gray-500 uppercase">Pix Copia e Cola (Manual)</label>
                    <textarea id="pix-manual" rows="3" class="w-full p-3 border rounded font-mono text-xs bg-gray-50" placeholder="Cole o c√≥digo Pix gerado pelo seu banco aqui..."></textarea>
                </div>

                <button onclick="lancarPedido()" id="btn-lancar" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 rounded-xl transition shadow-lg shadow-green-200">
                    + Lan√ßar Cobran√ßa
                </button>
                <p id="msg-status" class="mt-3 text-center text-sm font-medium"></p>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow overflow-hidden">
            <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
                <h2 class="text-blue-600 font-bold">Gerenciar Vendas Pendentes</h2>
                <button onclick="carregarVendasPendentes()" class="text-xs text-blue-500 hover:underline">Atualizar Lista</button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead class="bg-gray-100 text-gray-600 uppercase text-xs">
                        <tr>
                            <th class="p-4">ID</th>
                            <th class="p-4">Cliente (ID)</th>
                            <th class="p-4">Produto</th>
                            <th class="p-4">Valor</th>
                            <th class="p-4">Pix Atual</th>
                            <th class="p-4">A√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody id="tabela-vendas" class="divide-y divide-gray-100">
                        <tr><td colspan="6" class="p-4 text-center text-gray-400">Carregando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // SUAS CHAVES REAIS
        const supabaseUrl = 'https://eedegpggzooimuvytmyt.supabase.co'
        const supabaseKey = 'sb_publishable_7ib6PE-capYPhqdTrS0m2w_3d9QWE8x'
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey)

        // --- AUTENTICA√á√ÉO ---
        async function verificarLogin() {
            const { data: { session } } = await _supabase.auth.getSession();
            if (session) {
                mostrarPainel(session.user);
            } else {
                document.getElementById('tela-login').classList.remove('hidden');
                document.getElementById('painel-principal').classList.add('hidden');
            }
        }

        function mostrarPainel(user) {
            document.getElementById('tela-login').classList.add('hidden');
            document.getElementById('painel-principal').classList.remove('hidden');
            document.getElementById('user-email').innerText = user.email;
            
            // Inicia carregamento dos dados
            carregarClientes();
            carregarProdutos();
            carregarVendasPendentes();
        }

        async function fazerLogin() {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-senha').value;
            const btn = document.getElementById('btn-login');
            
            btn.innerText = "Entrando..."; btn.disabled = true;

            const { data, error } = await _supabase.auth.signInWithPassword({ email: email, password: pass });
            
            if (error) {
                document.getElementById('msg-login').innerText = "Erro: " + error.message;
                btn.innerText = "ENTRAR NO PAINEL"; btn.disabled = false;
            } else {
                window.location.reload();
            }
        }

        async function sair() {
            await _supabase.auth.signOut();
            window.location.reload();
        }

        // --- CARREGAMENTOS ---
        async function carregarClientes() {
            const { data } = await _supabase.from('clientes').select('*').order('nome');
            const lista = document.getElementById('lista-clientes');
            lista.innerHTML = "";

            if (data) {
                data.forEach(c => {
                    const div = document.createElement('div');
                    div.className = "p-3 border rounded cursor-pointer hover:bg-green-50 flex justify-between items-center cliente-item transition";
                    div.innerHTML = `<span class="font-bold capitalize">${c.nome} ${c.sobrenome}</span>`;
                    
                    div.onclick = () => {
                        document.querySelectorAll('.cliente-item').forEach(x => x.classList.remove('bg-green-100', 'border-green-500', 'ring-1', 'ring-green-500'));
                        div.classList.add('bg-green-100', 'border-green-500', 'ring-1', 'ring-green-500');
                        
                        document.getElementById('cliente-nome').value = c.nome + " " + c.sobrenome;
                        // AQUI EST√Å O SEGREDO: Usamos o id_auth para vincular a venda
                        document.getElementById('cliente-id').value = c.id_auth; 
                    };
                    lista.appendChild(div);
                });
            }
        }

        async function carregarProdutos() {
            const { data } = await _supabase.from('produtos').select('*');
            const sel = document.getElementById('select-produto');
            if(data) {
                data.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.nome;
                    opt.dataset.preco = p.preco;
                    opt.innerText = `${p.nome} - R$ ${p.preco}`;
                    sel.appendChild(opt);
                });
            }
        }

        function aoMudarProduto() {
            const sel = document.getElementById('select-produto');
            const preco = sel.options[sel.selectedIndex].dataset.preco;
            // CORRE√á√ÉO: Usando o ID 'campo-valor'
            if (preco) document.getElementById('campo-valor').value = preco;
        }

        function filtrarClientes() {
            const termo = document.getElementById('busca-cliente').value.toLowerCase();
            document.querySelectorAll('.cliente-item').forEach(item => {
                item.style.display = item.innerText.toLowerCase().includes(termo) ? "flex" : "none";
            });
        }

        // --- LAN√áAMENTO (SALVAR) ---
        async function lancarPedido() {
            const btn = document.getElementById('btn-lancar');
            const msg = document.getElementById('msg-status');

            // Pegando os valores com os IDs corretos
            const clienteId = document.getElementById('cliente-id').value;
            const produto = document.getElementById('select-produto').value;
            const valor = document.getElementById('campo-valor').value; // <--- AGORA VAI PEGAR O VALOR CERTO
            const pix = document.getElementById('pix-manual').value;

            // Valida√ß√£o
            if (!clienteId) { alert("Por favor, selecione um cliente na lista √† esquerda."); return; }
            if (!valor) { alert("Digite o valor da venda."); return; }

            btn.innerText = "Salvando..."; btn.disabled = true;

            const { error } = await _supabase.from('vendas').insert({
                email_cliente: clienteId, // Salva o ID do Auth do cliente
                produto: produto,
                valor: valor, // Agora envia o valor correto, n√£o null
                status: 'Pendente',
                pix_copia_cola: pix
            });

            if (error) {
                msg.innerText = "Erro: " + error.message; msg.style.color = "red";
                btn.innerText = "Tentar Novamente";
            } else {
                msg.innerText = "Venda Lan√ßada com Sucesso!"; msg.style.color = "green";
                btn.innerText = "+ Lan√ßar Outra";
                
                // Limpa campos
                document.getElementById('pix-manual').value = "";
                
                // Atualiza a tabela abaixo
                carregarVendasPendentes();
            }
            btn.disabled = false;
        }

        // --- LISTAGEM E ATUALIZA√á√ÉO ---
        async function carregarVendasPendentes() {
            const tb = document.getElementById('tabela-vendas');
            const { data } = await _supabase
                .from('vendas')
                .select('*')
                .eq('status', 'Pendente')
                .order('id', { ascending: false });

            if (!data || data.length === 0) {
                tb.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-gray-500">Nenhuma venda pendente.</td></tr>`;
                return;
            }

            tb.innerHTML = data.map(v => {
                const pixResumo = v.pix_copia_cola ? v.pix_copia_cola.substring(0, 10) + '...' : '<span class="text-red-400 text-xs">Pendente</span>';
                
                // Verifica se valor √© null para n√£o mostrar "R$ null"
                const valorDisplay = v.valor ? `R$ ${v.valor}` : `<span class="text-red-500 font-bold">R$ 0,00 (Erro)</span>`;

                return `
                    <tr class="hover:bg-gray-50 border-b border-gray-100">
                        <td class="p-4 font-mono text-xs text-gray-500">#${v.id}</td>
                        <td class="p-4 text-xs font-mono text-gray-600" title="${v.email_cliente}">${v.email_cliente.substring(0, 8)}...</td>
                        <td class="p-4 text-sm">${v.produto}</td>
                        <td class="p-4 font-bold text-green-700">${valorDisplay}</td>
                        <td class="p-4 font-mono text-xs">${pixResumo}</td>
                        <td class="p-4">
                            <button onclick="atualizarPix(${v.id})" class="bg-blue-100 text-blue-700 px-3 py-1 rounded text-xs font-bold hover:bg-blue-200 transition">
                                ‚úèÔ∏è Pix
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function atualizarPix(id) {
            const novo = prompt("Cole o novo c√≥digo Pix:");
            if(novo) {
                await _supabase.from('vendas').update({ pix_copia_cola: novo }).eq('id', id);
                alert("Pix atualizado!");
                carregarVendasPendentes();
            }
        }

        // Inicia
        verificarLogin();
    </script>
</body>
</html>
