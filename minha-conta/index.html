import { useEffect, useMemo, useState } from "react";
import type { ChangeEvent, CSSProperties, FormEvent } from "react";
import { useNavigate, useSearchParams } from "react-router-dom";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { useToast } from "@/hooks/use-toast";
import { supabase } from "@/integrations/supabase/client";
import { ShieldCheck, Truck, Lock } from "lucide-react";

function sleep(ms: number) {
  return new Promise((r) => setTimeout(r, ms));
}

async function ensureSessionReady(timeoutMs = 2500) {
  const start = Date.now();

  while (Date.now() - start < timeoutMs) {
    const { data } = await supabase.auth.getSession();
    if (data.session) return data.session;
    await sleep(150);
  }

  return null;
}

export default function Auth() {
  const navigate = useNavigate();
  const [searchParams] = useSearchParams();
  const { toast } = useToast();
  const [loading, setLoading] = useState(false);

  const [isLogin, setIsLogin] = useState(searchParams.get("mode") !== "register");

  useEffect(() => {
    const mode = searchParams.get("mode");
    setIsLogin(mode !== "register");
  }, [searchParams]);

  useEffect(() => {
    supabase.auth.getSession().then(({ data }) => {
      if (data.session) navigate("/dashboard");
    });
  }, [navigate]);

  const [formData, setFormData] = useState({
    email: "",
    password: "",
    firstName: "",
    lastName: "",
    cpf: "",
    birthDate: "",
    cep: "",
    street: "",
    number: "",
    complement: "",
    neighborhood: "",
    city: "",
    state: "",
  });

  const handleChange = (e: ChangeEvent<HTMLInputElement>) => {
    setFormData({ ...formData, [e.target.id]: e.target.value });
  };

  const handleAuth = async (e: FormEvent) => {
    e.preventDefault();
    setLoading(true);

    try {
      const email = formData.email.trim().toLowerCase();
      const password = formData.password;

      if (isLogin) {
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) throw error;

        const session = await ensureSessionReady();
        if (!session) {
          throw new Error("Login ok, mas sessão não carregou. Recarregue a página e tente novamente.");
        }

        navigate("/dashboard");
        return;
      }

      const { data: authData, error: authError } = await supabase.auth.signUp({
        email,
        password,
      });
      if (authError) throw authError;

      if (authData.user) {
        const { error: profileError } = await supabase.from("profiles").upsert({
          id: authData.user.id,
          email,
          first_name: formData.firstName,
          last_name: formData.lastName,
          cpf: formData.cpf,
          birth_date: formData.birthDate,
          cep: formData.cep,
          address_street: formData.street,
          address_number: formData.number,
          address_complement: formData.complement,
          address_neighborhood: formData.neighborhood,
          city: formData.city,
          state: formData.state,
        });

        if (profileError) throw profileError;

        toast({
          title: "Sucesso!",
          description: "Seu cadastro completo foi realizado com sucesso.",
        });

        await ensureSessionReady();
        navigate("/dashboard");
        return;
      }

      throw new Error("Cadastro criado, mas usuário não retornou. Tente fazer login.");
    } catch (error: any) {
      toast({
        variant: "destructive",
        title: "Erro no Processo",
        description: error?.message ?? "Erro desconhecido",
      });
    } finally {
      setLoading(false);
    }
  };

  const toggleMode = () => {
    const newMode = isLogin ? "register" : "login";
    setIsLogin(!isLogin);
    navigate(/auth?mode=${newMode});
  };

  const YELLOW = "#F5DE3E";
  const GREEN = "#00a38c";
  const GREEN_HOVER = "#008e7a";

  // logo sem fundo (PNG)
  const LOGO = "/logo.png";

  // imagem da tarja (arquivo no /public)
  const FAIXA = "/faixa%20de%20baixo.jpeg";

  const headline = useMemo(() => (isLogin ? "Acessar sua conta" : "Criar sua conta"), [isLogin]);

  return (
    <div className="min-h-screen relative overflow-hidden bg-[#F5DE3E]">
      {/* BACKGROUNDS (não colocar a tarja aqui) */}
      <div className="pointer-events-none absolute inset-0">
        <div className="absolute inset-0 bg-gradient-to-b from-[#F5DE3E] via-[#FFF3A6] to-white" />
        <div
          className="absolute -top-40 left-1/2 h-[720px] w-[720px] -translate-x-1/2 rounded-full blur-3xl opacity-70"
          style={{ background: radial-gradient(circle, ${YELLOW} 0%, transparent 62%) }}
        />
        <div
          className="absolute -bottom-56 -right-40 h-[680px] w-[680px] rounded-full blur-3xl opacity-25"
          style={{ background: radial-gradient(circle, ${GREEN} 0%, transparent 62%) }}
        />
      </div>

      {/* Conteúdo (pb = altura da tarja, pra não cobrir campos no final) */}
      <div className="container mx-auto px-4 relative pb-24">
        <div className="grid min-h-screen items-center gap-10 py-10 lg:grid-cols-2 lg:gap-14">
          {/* HERO (desktop) */}
          <aside className="hidden lg:block">
            <div className="max-w-xl">
              <img src={LOGO} alt="Logo" className="h-24 w-auto object-contain mb-6" />

              <div className="inline-flex items-center gap-2 rounded-full border border-black/10 bg-white/60 px-4 py-2 backdrop-blur">
                <ShieldCheck className="h-4 w-4" style={{ color: GREEN }} />
                <span className="text-sm font-semibold text-black/85">Sessão protegida</span>
                <span className="ml-2 inline-block h-1.5 w-1.5 rounded-full bg-black/60" />
              </div>

              <h1 className="mt-6 text-5xl font-display font-bold tracking-tight text-black leading-[1.05]">
                Acesso com padrão de empresa grande.
              </h1>

              <p className="mt-5 text-lg text-black/70 max-w-lg">
                Identidade forte, interface limpa, e operação consistente — do login ao dashboard.
              </p>

              <div className="mt-10 grid grid-cols-3 gap-3">
                {[
                  { k: "Segurança", v: "Camadas" },
                  { k: "Rastreio", v: "Eventos" },
                  { k: "Suporte", v: "Disputas" },
                ].map((x) => (
                  <div key={x.k} className="rounded-2xl border border-black/10 bg-white/55 backdrop-blur p-4">
                    <p className="text-sm font-semibold text-black/90">{x.k}</p>
                    <p className="mt-1 text-xs text-black/60">{x.v}</p>
                  </div>
                ))}
              </div>

              <div className="mt-8 flex items-center gap-3 rounded-2xl border border-black/10 bg-white/55 backdrop-blur p-4">
                <div
                  className="flex h-11 w-11 items-center justify-center rounded-2xl"
                  style={{ backgroundColor: ${GREEN}1A, color: GREEN }}
                >
                  {isLogin ? <Lock className="h-5 w-5" /> : <Truck className="h-5 w-5" />}
                </div>
                <div>
                  <p className="text-sm font-semibold text-black/90">{isLogin ? "Acesso rápido" : "Cadastro completo"}</p>
                  <p className="text-xs text-black/60">{isLogin ? "Entre e continue." : "Dados pessoais + endereço."}</p>
                </div>
              </div>
            </div>
          </aside>

          {/* CARD */}
          <main className="flex justify-center lg:justify-end">
            <div className="w-full max-w-md">
              <div className="overflow-hidden rounded-3xl border border-black/10 bg-[#FFF6D0]/95 backdrop-blur-xl shadow-[0_18px_60px_rgba(0,0,0,0.18)]">
                {/* HEADER do card (centralizado) */}
                <div className="px-8 pt-9 pb-7">
                  <div className="flex flex-col items-center text-center">
                    <img src={LOGO} alt="Logo" className="h-16 w-auto object-contain mb-3" />
                    <h2 className="text-2xl font-display font-bold text-black leading-tight">{headline}</h2>
                  </div>

                  <div className="mt-6 h-px w-full bg-black/10" />
                  <div className="mt-2 h-[3px] w-24 rounded-full mx-auto" style={{ background: YELLOW }} />
                </div>

                <form className="px-8 pb-9 space-y-6" onSubmit={handleAuth}>
                  <div className="space-y-4">
                    <div className="space-y-2">
                      <Label htmlFor="email" className="text-black/85">
                        E-mail
                      </Label>
                      <Input
                        id="email"
                        type="email"
                        required
                        autoComplete="email"
                        placeholder="seu@email.com"
                        value={formData.email}
                        onChange={handleChange}
                        className="h-11 rounded-xl border-black/15 bg-white/70 backdrop-blur focus-visible:ring-2"
                        style={{ "--tw-ring-color": ${GREEN}33 } as CSSProperties}
                      />
                    </div>

                    <div className="space-y-2">
                      <Label htmlFor="password" className="text-black/85">
                        Senha
                      </Label>
                      <Input
                        id="password"
                        type="password"
                        required
                        autoComplete={isLogin ? "current-password" : "new-password"}
                        placeholder="Mínimo 6 caracteres"
                        value={formData.password}
                        onChange={handleChange}
                        className="h-11 rounded-xl border-black/15 bg-white/70 backdrop-blur focus-visible:ring-2"
                        style={{ "--tw-ring-color": ${GREEN}33 } as CSSProperties}
                      />
                    </div>
                  </div>

                  {!isLogin && (
                    <div className="space-y-6 pt-4 border-t border-black/10 animate-in fade-in duration-500">
                      <div className="space-y-4">
                        <div className="flex items-center justify-between">
                          <h3 className="text-xs font-semibold tracking-wide text-black/70 uppercase">Dados pessoais</h3>
                          <div className="h-px flex-1 ml-4 bg-black/10" />
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                          <div className="space-y-2">
                            <Label htmlFor="firstName" className="text-black/85">
                              Nome
                            </Label>
                            <Input
                              id="firstName"
                              required
                              value={formData.firstName}
                              onChange={handleChange}
                              className="h-11 rounded-xl border-black/15 bg-white/70 backdrop-blur focus-visible:ring-2"
                              style={{ "--tw-ring-color": ${GREEN}33 } as CSSProperties}
                            />
                          </div>

                          <div className="space-y-2">
                            <Label htmlFor="lastName" className="text-black/85">
                              Sobrenome
                            </Label>
                            <Input
                              id="lastName"
                              required
                              value={formData.lastName}
                              onChange={handleChange}
                              className="h-11 rounded-xl border-black/15 bg-white/70 backdrop-blur focus-visible:ring-2"
                              style={{ "--tw-ring-color": ${GREEN}33 } as CSSProperties}
                            />
                          </div>
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                          <div className="space-y-2">
                            <Label htmlFor="cpf" className="text-black/85">
                              CPF
                            </Label>
                            <Input
                              id="cpf"
                              required
                              placeholder="000.000.000-00"
                              value={formData.cpf}
                              onChange={handleChange}
                              className="h-11 rounded-xl border-black/15 bg-white/70 backdrop-blur focus-visible:ring-2"
                              style={{ "--tw-ring-color": ${GREEN}33 } as CSSProperties}
                            />
                          </div>

                          <div className="space-y-2">
                            <Label htmlFor="birthDate" className="text-black/85">
                              Nascimento
                            </Label>
                            <Input
                              id="birthDate"
                              type="date"
                              required
                              value={formData.birthDate}
                              onChange={handleChange}
                              className="h-11 rounded-xl border-black/15 bg-white/70 backdrop-blur focus-visible:ring-2"
                              style={{ "--tw-ring-color": ${GREEN}33 } as CSSProperties}
                            />
                          </div>
                        </div>
                      </div>

                      <div className="space-y-4">
                        <div className="flex items-center justify-between">
                          <h3 className="flex items-center gap-2 text-xs font-semibold tracking-wide text-black/70 uppercase">
                            <Truck className="h-4 w-4" />
                            Endereço de entrega
                          </h3>
                          <div className="h-px flex-1 ml-4 bg-black/10" />
                        </div>

                        <div className="grid grid-cols-3 gap-4">
                          <div className="col-span-1 space-y-2">
                            <Label htmlFor="cep" className="text-black/85">
                              CEP
                            </Label>
                            <Input
                              id="cep"
                              required
                              placeholder="00000-000"
                              value={formData.cep}
                              onChange={handleChange}
                              className="h-11 rounded-xl border-black/15 bg-white/70 backdrop-blur focus-visible:ring-2"
                              style={{ "--tw-ring-color": ${GREEN}33 } as CSSProperties}
                            />
                          </div>

                          <div className="col-span-2 space-y-2">
                            <Label htmlFor="street" className="text-black/85">
                              Rua
                            </Label>
                            <Input
                              id="street"
                              required
                              value={formData.street}
                              onChange={handleChange}
                              className="h-11 rounded-xl border-black/15 bg-white/70 backdrop-blur focus-visible:ring-2"
                              style={{ "--tw-ring-color": ${GREEN}33 } as CSSProperties}
                            />
                          </div>
                        </div>

                        <div className="grid grid-cols-3 gap-4">
                          <div className="col-span-1 space-y-2">
                            <Label htmlFor="number" className="text-black/85">
                              Número
                            </Label>
                            <Input
                              id="number"
                              required
                              value={formData.number}
                              onChange={handleChange}
                              className="h-11 rounded-xl border-black/15 bg-white/70 backdrop-blur focus-visible:ring-2"
                              style={{ "--tw-ring-color": ${GREEN}33 } as CSSProperties}
                            />
                          </div>

                          <div className="col-span-2 space-y-2">
                            <Label htmlFor="complement" className="text-black/85">
                              Complemento
                            </Label>
                            <Input
                              id="complement"
                              value={formData.complement}
                              onChange={handleChange}
                              className="h-11 rounded-xl border-black/15 bg-white/70 backdrop-blur focus-visible:ring-2"
                              style={{ "--tw-ring-color": ${GREEN}33 } as CSSProperties}
                            />
                          </div>
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                          <div className="space-y-2">
                            <Label htmlFor="neighborhood" className="text-black/85">
                              Bairro
                            </Label>
                            <Input
                              id="neighborhood"
                              required
                              value={formData.neighborhood}
                              onChange={handleChange}
                              className="h-11 rounded-xl border-black/15 bg-white/70 backdrop-blur focus-visible:ring-2"
                              style={{ "--tw-ring-color": ${GREEN}33 } as CSSProperties}
                            />
                          </div>

                          <div className="space-y-2">
                            <Label htmlFor="city" className="text-black/85">
                              Cidade
                            </Label>
                            <Input
                              id="city"
                              required
                              value={formData.city}
                              onChange={handleChange}
                              className="h-11 rounded-xl border-black/15 bg-white/70 backdrop-blur focus-visible:ring-2"
                              style={{ "--tw-ring-color": ${GREEN}33 } as CSSProperties}
                            />
                          </div>
                        </div>

                        <div className="space-y-2">
                          <Label htmlFor="state" className="text-black/85">
                            Estado (UF)
                          </Label>
                          <Input
                            id="state"
                            required
                            placeholder="Ex: SP"
                            maxLength={2}
                            value={formData.state}
                            onChange={handleChange}
                            className="h-11 rounded-xl border-black/15 bg-white/70 backdrop-blur focus-visible:ring-2"
                            style={{ "--tw-ring-color": ${GREEN}33 } as CSSProperties}
                          />
                        </div>
                      </div>
                    </div>
                  )}

                  <Button
                    type="submit"
                    size="lg"
                    disabled={loading}
                    className="w-full rounded-xl font-semibold text-white shadow-[0_14px_34px_rgba(0,0,0,0.22)] transition-all
                               bg-[linear-gradient(135deg,#00a38c_0%,#008e7a_100%)]
                               hover:bg-[linear-gradient(135deg,#008e7a_0%,#006e5f_100%)]
                               active:scale-[0.99]"
                  >
                    {loading ? "Processando..." : isLogin ? "Entrar" : "Criar Conta"}
                  </Button>

                  <div className="text-center pt-1">
                    <button
                      type="button"
                      onClick={toggleMode}
                      className="text-sm font-medium hover:underline"
                      style={{ color: GREEN_HOVER }}
                    >
                      {isLogin ? "Não tem uma conta? Criar agora" : "Já tem uma conta? Fazer login"}
                    </button>
                  </div>
                </form>
              </div>

              <p className="mt-4 text-center text-xs text-black/55">
                Ao continuar, você concorda com os termos e políticas aplicáveis.
              </p>
            </div>
          </main>
        </div>
      </div>

      {/* TARJA INFERIOR (full-width, fixa no viewport) */}
      <div class="footer__disclaimer">
  <div class="lost-container">
    <div class="footer__disclaimer-logo-wrapper">
      <link itemprop="url" href="https://pagseguro.uol.com.br/" />
      <link
        itemprop="logo"
        href="//assets.pagseguro.com.br/ps-website-assets/v15.257.0/ps-bootstrap/svg/pagbank/logo-pagbank-negative-filled.svg"
      />

      <img
        width="102"
        height="28"
        class="footer__disclaimer-logo"
        src="//assets.pagseguro.com.br/ps-website-assets/v15.257.0/ps-bootstrap/svg/pagbank/logo-pagbank-negative-filled.svg"
        alt="garantindo"
      />
    </div>

    <div class="footer__disclaimer-text">
      <p>© 1996-2025 Todos os direitos reservados.</p>
      <p>
        <span itemprop="name">PAGSEGURO INTERNET INSTITUIÇÃO DE PAGAMENTO S/A</span>
        - CNPJ/MF 08.561.701/0001-01
      </p>
      <p itemscope itemtype="http://schema.org/PostalAddress" itemprop="location">
        <span itemprop="streetAddress">Av. Brigadeiro Faria Lima, 1.384</span>,
        <span itemprop="addressLocality">São Paulo</span> -
        <span itemprop="addressRegion">SP</span> - CEP
        <span itemprop="postalCode">01451-001</span>
        <meta itemprop="addressCountry" content="BR" />
      </p>
    </div>
  </div>
</div>

      <footer className="fixed bottom-0 left-0 right-0 z-50 bg-black">
        <img src={FAIXA} alt="Faixa inferior" className="w-full h-24 object-contain" />
      </footer>
    </div>
  );
}
